# Services needed for Open edX to work
version: "3.5"
services:
  {% include "mysql.yml.j2" %}
  {% include "mongodb.yml.j2" %}
  {% include "elasticsearch.yml.j2" %}

  rabbitmq:
    image: rabbitmq:3.6.16-alpine
    restart: unless-stopped
    hostname: rabbitmq
    container_name: rabbitmq
    healthcheck:
      test: rabbitmqctl node_health_check | grep "Health check passed" -q
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 10s
    volumes:
      - {{ project.rabbitmq_docker_volume }}:/etc/rabbitmq/
      - {{ project.rabbitmq_docker_volume }}:/var/lib/rabbitmq
      - {{ project.rabbitmq_docker_volume }}:/var/log/rabbitmq/
    networks:
      - derex

  mailslurper:
    image: derex/mailslurper:1.14.1
    restart: unless-stopped
    container_name: smtp
    volumes:
      - ./mailslurper.json:/config.json
    networks:
      derex:
        aliases:
          - mailslurper.localhost.derex

  memcached:
    image: memcached:1.6.3-alpine
    restart: unless-stopped
    container_name: memcached
    healthcheck:
      test: nc -z 127.0.0.1 11211
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 10s
    networks:
      - derex

  minio:
    image: minio/minio:RELEASE.2021-08-20T18-32-01Z
    restart: unless-stopped
    container_name: minio
    volumes:
      - {{ project.minio_docker_volume }}:/data
    environment:
      MINIO_ROOT_USER: "project.minio_user"
      MINIO_ROOT_PASSWORD: "project.minio_password"
    command: server --console-address :80 /data
    healthcheck:
      test: curl --silent --fail http://localhost:80/minio/health/live
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      derex:
        aliases:
          - minio.localhost.derex
          - minio.localhost

  {%- if enable_host_caddy %}
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    container_name: caddy
    ports:
      - 127.0.0.1:80:80
      - 127.0.0.1:81:81
      - 127.0.0.1:4301:4301 # Mailslurper port
    volumes:
      - {{ host_caddy_dir }}:/etc/caddy
      {%- if host_caddy_config_path %}
      - {{ host_caddy_config_path }}:/etc/caddy/Caddyfile
      {%- endif %}
    healthcheck:
      test: wget -q -O - http://localhost:8080
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - derex
  {%- endif %}

networks:
  derex:
    name: derex

volumes:
  {%- for volume in project.docker_volumes %}
  {{ volume }}:
    external: true
  {%- endfor %}
