pool:
  vmImage: 'ubuntu-latest'

steps:
- script: |
    set -ex
    docker network create -d bridge derex
    docker run -d --network derex --name mysql --rm -e MYSQL_ALLOW_EMPTY_PASSWORD=True mysql:5.6.44 mysqld --character-set-server=utf8 --collation-server=utf8_general_ci
  displayName: 'Start mysql'

- script: |
    set -ex
    sudo systemctl stop mysql
    docker run -d --network derex --name mongodb --rm mongo:3.2.16 mongod --smallfiles --nojournal --storageEngine wiredTiger
  displayName: 'Start mongodb'

- script: docker run --network derex --rm derex/openedx-ironwood:latest restore_dump.py
  displayName: 'Prime mysql database'

- script: docker run -v ironwood-staticfiles:/openedx/staticfiles/ --network derex --rm derex/openedx-ironwood:latest compile_assets.sh
  displayName: 'Compile static assets'

- script: docker run -d -p 8000:8000 -v ironwood-staticfiles:/openedx/staticfiles/ --network derex --rm derex/openedx-ironwood:latest sh -c 'gunicorn --name ${SERVICE_VARIANT} --bind=0.0.0.0:8000 --max-requests=1000 wsgi:application'
  displayName: 'Start lms'

- script: curl http://localhost:8000/
  displayName: 'Run a curl'
