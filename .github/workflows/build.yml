name: Build
on: [push]

env:
  CACHE_KEY_BASE: 22 # Increment this value to reset the images cache
  CACHE_KEY_FILES: ${{ github.workspace }}/docker-definition/**/*
  CACHE_KEY_IMAGES: BASE_SEED=$CACHE_KEY_BASE | $CACHE_KEY_FILES
  IMAGE_CACHE_PATH: ${{ github.workspace }}/image_cache
  SENTINEL_CACHE_PATH: ${{ github.workspace }}/sentinel_cache

jobs:
  juniper:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DOCKER_IMAGES_SLUG: juniper
    steps:
      - uses: actions/checkout@v3

      - name: Docker images sentinel cache
        id: cache-sentinel
        uses: actions/cache@v3
        with:
          path: $(SENTINEL_CACHE_PATH)
          key: SENTINEL=1 | $(DOCKER_IMAGES_SLUG) | $(CACHE_KEY_IMAGES)

      - name: Docker images cache
        if: steps.cache-sentinel.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: $IMAGE_CACHE_PATH
          key: BASE_SEED=$(CACHE_KEY_BASE) | $DOCKER_IMAGES_SLUG | $(CACHE_KEY_IMAGES)
          restore-keys: BASE_SEED=$(CACHE_KEY_BASE) | $DOCKER_IMAGES_SLUG

      - name: Load images
        if: steps.cache-sentinel.outputs.cache-hit != 'true'
        run: |
          [ -d $IMAGE_CACHE_PATH ] || exit 0
          ls -l $IMAGE_CACHE_PATH
          docker images
          set -euxo pipefail
          cat $IMAGE_CACHE_PATH/edx-$DOCKER_IMAGES_SLUG.tar.xz | unxz | docker load
          docker images

      - name: Set needs_build pipeline variable
        if: steps.cache-sentinel.outputs.cache-hit != 'true'
        run: echo "NEEDS_BUILD=true" >> $GITHUB_ENV

      - name: Remove Haskell compiler and cached apt archives to save disk space
        if: env.NEEDS_BUILD != 'false' && success()
        run: df -h; time sudo rm -rf /var/cache/apt/archives /opt/ghc; df -h

      - name: Prepare Transifex credentials
        if: env.NEEDS_BUILD != 'false'
        run: |
          if [ "$TRANSIFEX_USERNAME" == '$(TRANSIFEX_USERNAME)' ] || [ "$TRANSIFEX_PASSWORD" == '$(TRANSIFEX_PASSWORD)' ]; then
                    echo "Transifex credentials unset. Building without translations."
                    exit 0
          fi
          printf '[https://www.transifex.com]\nhostname=https://www.transifex.com\nusername=%s\npassword=%s\n' "${TRANSIFEX_USERNAME}" "${TRANSIFEX_PASSWORD}" > $HOME/.transifexrc
          ls -l $GITHUB_WORKSPACE/.transifexrc
        env:
          TRANSIFEX_USERNAME: $(TRANSIFEX_USERNAME)
          TRANSIFEX_PASSWORD: $(TRANSIFEX_PASSWORD)

      - name: Setup docker images cache
        if: env.NEEDS_BUILD != 'false' && success()
        run: |
          images=$(docker images|grep -v '<none>'|grep derex|awk '{print $1 ":" $2}')
          CACHE_FROM_OPTS=""
          if [ -d $IMAGE_CACHE_PATH ]; then
            echo "Will use cached layers from images $images"
            for image in $images; do
            CACHE_FROM_OPTS="${CACHE_FROM_OPTS} --cache-from=$image"
            done
          else
            mkdir $IMAGE_CACHE_PATH
          fi
          echo "CACHE_FROM_OPTS=$CACHE_FROM_OPTS" >> $GITHUB_ENV
          if [ -d $SENTINEL_CACHE_PATH ]; then rm -r $SENTINEL_CACHE_PATH; else mkdir $SENTINEL_CACHE_PATH; fi
          cp -r $CACHE_KEY_FILES $SENTINEL_CACHE_PATH
          # We save the sha of the repo that built this image, so that we can push
          # it only in a build of the same commit, after tests are passed
          git rev-parse --verify HEAD > $SENTINEL_CACHE_PATH/built_version

  koa:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DOCKER_IMAGES_SLUG: koa
    steps:
      - uses: actions/checkout@v3

      - name: Docker images sentinel cache
        id: cache-sentinel
        uses: actions/cache@v3
        with:
          path: $(SENTINEL_CACHE_PATH)
          key: SENTINEL=1 | $(DOCKER_IMAGES_SLUG) | $(CACHE_KEY_IMAGES)

  lilac:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DOCKER_IMAGES_SLUG: lilac
    steps:
      - uses: actions/checkout@v3

      - name: Docker images sentinel cache
        id: cache-sentinel
        uses: actions/cache@v3
        with:
          path: $(SENTINEL_CACHE_PATH)
          key: SENTINEL=1 | $(DOCKER_IMAGES_SLUG) | $(CACHE_KEY_IMAGES)
